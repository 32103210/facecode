# LLM修复检查清单

## 📋 快速检查步骤

### 第一步：检查文件是否创建/修改成功

```bash
# 在项目根目录执行
ls -l prompt/simple_system_prompt.txt
ls -l LLM_FIX_COMPLETE.md
ls -l test-llm-fix.md
ls -l LLM修复总结.md
```

**预期结果**：所有文件都应该存在

### 第二步：检查后端代码修改

```bash
# 查看关键修改
grep -n "simple_system_prompt" backend/controllers/analysisController.js
grep -n "parseAIResponse" backend/controllers/analysisController.js
grep -n "validateAnalysisStructure" backend/controllers/analysisController.js
```

**预期结果**：
- 第8行附近：`prompt/simple_system_prompt.txt`
- 第104行附近：`parseAIResponse(content)`
- 第108行附近：`validateAnalysisStructure(analysis)`
- 第145行附近：`function parseAIResponse(content)`
- 第193行附近：`function validateAnalysisStructure(analysis)`

### 第三步：检查前端配置

```bash
# 查看配置
grep -n "DEBUG_MODE" js/config.js
```

**预期结果**：
- 应该看到 `DEBUG_MODE: false,  // 设置为 true 时输出详细调试信息`

### 第四步：启动并测试

#### A. Mock模式测试（推荐先测试）

```bash
# 1. 确认配置
cat js/config.js | grep MOCK_MODE
# 应该显示：MOCK_MODE: true

# 2. 启动前端
python3 -m http.server 8000 &

# 3. 在浏览器打开
echo "请在浏览器访问: http://localhost:8000"
```

**测试步骤**：
1. 访问 http://localhost:8000
2. 点击"开始分析"或上传照片按钮
3. 上传任意人脸照片
4. 等待2秒（模拟延迟）
5. 自动跳转到结果页

**验证点**：
- ✅ 命运总览显示："你的面藏风水，气自成局；命中注定不是随波逐流的人。"
- ✅ 五官解读显示5个部位（额、眉、眼、鼻、唇）
- ✅ 气运分析显示："气聚中庭，贵人运渐起..."
- ✅ 修炼建议显示："静坐三息，观心而不执..."
- ✅ 可以点击各个标签页（五官解读、气运分析、修炼建议、谁能旺你）

#### B. 真实API测试（需要OpenAI API Key）

```bash
# 1. 启动后端
cd backend
npm start &

# 2. 在新终端启动前端
cd ..
python3 -m http.server 8000 &
```

**配置修改**：
编辑 `js/config.js`：
```javascript
MOCK_MODE: false,  // 改为 false
DEBUG_MODE: true,  // 改为 true（方便调试）
```

**测试步骤**：
1. 访问 http://localhost:8000
2. 点击设置图标（如果有）或在首页输入API Key
3. 输入有效的OpenAI API Key（格式：sk-...）
4. 勾选"保存API Key"
5. 上传人脸照片
6. 等待10-30秒（真实API调用需要时间）
7. 观察浏览器控制台（F12）

**后端日志检查**：
在后端终端应该看到：
```
✅ 简化版系统提示词加载成功
🔍 开始分析面相...
📸 图片大小: xxxxxx
✅ OpenAI 返回内容（前500字符）: ...
📏 返回内容总长度: xxxx
✅ JSON 解析成功
✅ 数据结构验证通过
```

**浏览器控制台检查**：
按F12打开开发者工具，在Console标签应该看到：
```
Session 数据: 已获取
图片数据长度: xxxxxx
开始调用 API...
API 调用结果: {ok: true, analysis: {...}}
🔍 [DEBUG] API 原始响应: {ok: true, analysis: {...}}
准备跳转到结果页
```

**验证点**：
- ✅ 命运总览显示个性化内容（不是mock数据）
- ✅ 五官解读显示5个部位，内容各不相同
- ✅ 气运分析显示个性化运势分析
- ✅ 修炼建议显示个性化建议
- ✅ 传播金句有趣且个性化

### 第五步：测试调试功能

在浏览器控制台（F12 > Console）执行：

```javascript
// 查看保存的API响应
const response = JSON.parse(localStorage.getItem('last_api_response'));
console.log(response);

// 检查结构是否正确
console.log('命运总览:', response?.analysis?.命运总览);
console.log('五官解读:', response?.analysis?.五官解读);
console.log('气运分析:', response?.analysis?.气运分析);
console.log('修炼建议:', response?.analysis?.修炼建议);
console.log('传播金句:', response?.analysis?.传播金句);
```

**预期结果**：应该看到完整的JSON结构

### 第六步：测试错误处理

#### 测试A：无效API Key
1. 输入无效的API Key（如：`sk-invalid123`）
2. 上传照片
3. 应该看到错误提示："分析失败: Incorrect API key provided..."

#### 测试B：后端未启动
1. 停止后端服务（Ctrl+C）
2. 设置 `MOCK_MODE: false`
3. 上传照片
4. 应该看到错误提示："分析失败: Failed to fetch"

## 📊 完整检查清单

### 文件创建/修改
- [x] `prompt/simple_system_prompt.txt` 已创建
- [x] `backend/controllers/analysisController.js` 已修改
- [x] `js/config.js` 已修改（添加DEBUG_MODE）
- [x] `js/api.js` 已修改（增强错误处理）
- [x] `js/loading.js` 已修改（改进错误提示）
- [x] `LLM_FIX_COMPLETE.md` 已创建
- [x] `test-llm-fix.md` 已创建
- [x] `LLM修复总结.md` 已创建
- [x] `检查清单.md` 已创建

### 功能测试
- [ ] Mock模式工作正常
- [ ] 真实API返回正确JSON
- [ ] 所有5个板块内容显示
- [ ] 错误提示清晰明确
- [ ] 调试模式可查看响应
- [ ] 后端日志详细清晰

### 代码质量
- [x] 无语法错误（已通过linter检查）
- [x] 函数命名清晰
- [x] 注释完整
- [x] 日志输出详细

## 🔍 常见问题排查

### 问题1：simple_system_prompt.txt加载失败

**症状**：后端日志显示"⚠️ 无法加载系统提示词，使用默认提示词"

**检查**：
```bash
ls -l prompt/simple_system_prompt.txt
cat prompt/simple_system_prompt.txt | head -5
```

**解决**：确认文件存在且内容正确

### 问题2：JSON解析失败

**症状**：错误提示"AI 返回的内容格式不正确: JSON解析失败"

**检查**：
1. 启用 `DEBUG_MODE: true`
2. 查看 `localStorage.getItem('last_api_response')`
3. 查看后端日志中的"原始返回内容"

**可能原因**：
- OpenAI API返回非JSON格式
- API Key无效
- 网络问题导致响应不完整

### 问题3：字段验证失败

**症状**：错误提示"缺少必需字段: xxx"或"五官解读缺少部位: xxx"

**检查**：查看后端日志，确认LLM返回的内容

**可能原因**：
- prompt没有正确加载
- max_tokens设置太小
- temperature设置不当

**解决**：
```javascript
// backend/controllers/analysisController.js
max_tokens: 4000,  // 增加到5000
temperature: 0.7   // 保持在0.6-0.8之间
```

### 问题4：result-simple.html内容不显示

**症状**：页面空白或显示"加载中..."

**检查**：
1. 打开浏览器控制台（F12）
2. 查看是否有JavaScript错误
3. 检查Session数据：`sessionStorage.getItem('current_result')`

**可能原因**：
- 数据没有保存到sessionStorage
- 字段名称不匹配
- displayAnalysisResults函数出错

## 📞 需要帮助？

如果遇到问题：

1. **查看日志**
   - 浏览器控制台（F12）
   - 后端终端输出

2. **查看调试信息**
   ```javascript
   // 浏览器控制台
   localStorage.getItem('last_api_response')
   localStorage.getItem('last_api_error')
   sessionStorage.getItem('current_result')
   ```

3. **查看文档**
   - `LLM_FIX_COMPLETE.md` - 详细说明
   - `test-llm-fix.md` - 测试指南
   - `LLM修复总结.md` - 快速参考

## ✅ 验收标准

全部通过即表示修复成功：

- ✅ 所有文件创建/修改完成
- ✅ 无语法错误
- ✅ Mock模式正常工作
- ✅ 真实API返回正确结构
- ✅ result-simple.html正确显示所有内容
- ✅ 错误处理完善
- ✅ 调试功能可用

---

**当前状态**：✅ 代码修改已完成，等待测试验证

**下一步**：按照上述步骤进行测试，验证所有功能正常





